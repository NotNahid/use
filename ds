# ==========================================
# üîπ PERMANENT WINRM NO-PASSWORD CONFIG (TARGET PC)
# ==========================================

# Run as admin
if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
    Write-Host "‚ùå Please run PowerShell as Administrator!" -ForegroundColor Red
    break
}

# 1Ô∏è‚É£ Enable PS Remoting if not enabled
if ((Get-Item WSMan:\localhost\Service\AllowUnencrypted).Value -ne $true -or
    (Get-Item WSMan:\localhost\Service\Auth\Basic).Value -ne $true) {
    Enable-PSRemoting -Force
}

# 2Ô∏è‚É£ Make sure WinRM service is Automatic and running
Set-Service -Name WinRM -StartupType Automatic
if ((Get-Service WinRM).Status -ne 'Running') { Start-Service WinRM }

# 3Ô∏è‚É£ Allow Basic Auth and unencrypted (only if not set)
Set-Item WSMan:\localhost\Service\Auth\Basic -Value $true
Set-Item WSMan:\localhost\Service\AllowUnencrypted -Value $true

# 4Ô∏è‚É£ Allow blank passwords permanently
$lsaPath = "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa"
if ((Get-ItemProperty -Path $lsaPath -Name limitblankpassworduse).limitblankpassworduse -ne 0) {
    Set-ItemProperty -Path $lsaPath -Name limitblankpassworduse -Value 0
}

# 5Ô∏è‚É£ Add user permanently to Remote Management Users group
$user1 = "work station"
$user2 = "$env:COMPUTERNAME\$user1"
$group = "Remote Management Users"
if (-not (Get-LocalGroupMember -Group $group -Name $user1 -ErrorAction SilentlyContinue)) {
    Add-LocalGroupMember -Group $group -Member $user1
}
if (-not (Get-LocalGroupMember -Group $group -Name $user2 -ErrorAction SilentlyContinue)) {
    Add-LocalGroupMember -Group $group -Member $user2
}

# 6Ô∏è‚É£ Ensure WinRM listener exists
$listener = winrm enumerate winrm/config/listener | Where-Object { $_ -match "Transport = HTTP" }
if (-not $listener) {
    winrm create winrm/config/Listener?Address=*+Transport=HTTP
}

# 7Ô∏è‚É£ Ensure firewall rule is enabled for Private networks
$rule = Get-NetFirewallRule -Name "WINRM-HTTP-In-TCP" -ErrorAction SilentlyContinue
if ($rule -and $rule.Enabled -ne "True") {
    Enable-NetFirewallRule -Name "WINRM-HTTP-In-TCP" -Profile Private
}

# ‚úÖ All done
Write-Host "‚úÖ TARGET PC is PERMANENTLY ready for NO-PASSWORD remote PowerShell!" -ForegroundColor Green
